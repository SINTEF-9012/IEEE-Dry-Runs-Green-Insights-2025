apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: nhrf-
spec:
  entrypoint: nhrf
  volumeClaimTemplates:
  - metadata:
      name: workdir
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 200Gi
  templates:
  - name: nhrf
    dag:
      tasks:
      - name: get-data
        template: get-data
        arguments:
          artifacts:
            - name: fastq-data
              s3:
                key: nhrf/samples
                bucket: artifacts
                endpoint: simpipe-minio.default.svc.cluster.local:9000
                insecure: true
                accessKeySecret:
                  name: simpipe-minio
                  key: root-user
                secretKeySecret:
                  name: simpipe-minio
                  key: root-password
            - name: ref-genome-data
              s3:
                key: nhrf/reference_genome
                bucket: artifacts
                endpoint: simpipe-minio.default.svc.cluster.local:9000
                insecure: true
                accessKeySecret:
                  name: simpipe-minio
                  key: root-user
                secretKeySecret:
                  name: simpipe-minio
                  key: root-password
      - name: trimming
        depends: "get-data.Succeeded"
        template: trimming
        arguments:
          artifacts:
            - name: fastq-data-out
              from: "{{tasks.get-data.outputs.artifacts.fastq-data-out}}"
            - name: ref-genome-data-out
              from: "{{tasks.get-data.outputs.artifacts.ref-genome-data-out}}"
      - name: alignment-bwa
        depends: "trimming.Succeeded"
        template: alignment-bwa
        arguments:
          artifacts:
            - name: trimming-out
              from: "{{tasks.trimming.outputs.artifacts.trimming-out}}"
            - name: ref-genome-data-out
              from: "{{tasks.get-data.outputs.artifacts.ref-genome-data-out}}"
      - name: alignment-samtools
        depends: "alignment-bwa.Succeeded"
        template: alignment-samtools
        arguments:
          artifacts:
            - name: alignment-bwa-out
              from: "{{tasks.alignment-bwa.outputs.artifacts.alignment-bwa-out}}"
            - name: ref-genome-data-out
              from: "{{tasks.get-data.outputs.artifacts.ref-genome-data-out}}"
      - name: mark-duplicates
        depends: "alignment-samtools.Succeeded"
        template: mark-duplicates
        arguments:
          artifacts:
            - name: alignment-samtools-out
              from: "{{tasks.alignment-samtools.outputs.artifacts.alignment-samtools-out}}"
      - name: base-quality-score
        depends: "mark-duplicates.Succeeded"
        template: base-quality-score
        arguments:
          artifacts:
            - name: mark-duplicates-out
              from: "{{tasks.mark-duplicates.outputs.artifacts.mark-duplicates-out}}"
            - name: ref-genome-data-out
              from: "{{tasks.get-data.outputs.artifacts.ref-genome-data-out}}"

# Templates
  - name: get-data
    container: 
      image: alpine:latest
      command: ["/bin/sh", "-c"]
      args:
        - |
          mkdir -p /mnt/data/fastq_data
          mkdir -p /mnt/data/ref_genome
          echo "copying fastq data..."
          cp -r /data/fastq_data/* /mnt/data/fastq_data
          echo "copying reference genome..."
          cp -r /data/ref_genome/* /mnt/data/ref_genome
          echo "copying done..."
          echo "listing files fastq_data..."
          ls -la /mnt/data/fastq_data
          echo "listing files ref_genome..."
          ls -la /mnt/data/ref_genome
          echo "done."
    inputs:
      artifacts:
        - name: fastq-data
          path: /data/fastq_data
        - name: ref-genome-data
          path: /data/ref_genome
    outputs:
      artifacts:
        - name: fastq-data-out
          path: /mnt/data/fastq_data
        - name: ref-genome-data-out
          path: /mnt/data/ref_genome
    volumeMounts:
      - name: workdir
        mountPath: /mnt/data

  - name: trimming
    container:
      image: quay.io/biocontainers/fastp:0.23.4--h125f33a_4
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "trimming starting..."
          ls -la /mnt/data/fastq_data
          mkdir -p ${OUTDIR}
          fastp -i ${TUMOR_FASTQ1} -I ${TUMOR_FASTQ2} -o ${OUTDIR}/trimmed_tumor_R1.fastq.gz -O ${OUTDIR}/trimmed_tumor_R2.fastq.gz -h ${OUTDIR}/tumor_fastp.html -j ${OUTDIR}/tumor_fastp.json || exit 1
          fastp -i ${NORMAL_FASTQ1} -I ${NORMAL_FASTQ2} -o ${OUTDIR}/trimmed_normal_R1.fastq.gz -O ${OUTDIR}/trimmed_normal_R2.fastq.gz -h ${OUTDIR}/normal_fastp.html -j ${OUTDIR}/normal_fastp.json || exit 1
          ls -la ${OUTDIR}
          echo "done."
      env:
        - name: OUTDIR
          value: /mnt/data/trimmed_data
        - name: TUMOR_FASTQ1
          value: /mnt/data/fastq_data/SRR24141497_1.fastq.gz
        - name: TUMOR_FASTQ2
          value: /mnt/data/fastq_data/SRR24141497_2.fastq.gz
        - name: NORMAL_FASTQ1
          value: /mnt/data/fastq_data/SRR24141508_1.fastq.gz
        - name: NORMAL_FASTQ2
          value: /mnt/data/fastq_data/SRR24141508_2.fastq.gz
    inputs:
      artifacts:
        - name: fastq-data-out
          path: /mnt/data/fastq_data
    outputs:
      artifacts:
        - name: trimming-out
          path: /mnt/data/trimmed_data
    volumeMounts:
      - name: workdir
        mountPath: /mnt/data

  - name: alignment-bwa
    container:
      image: quay.io/biocontainers/bwa:0.7.13--1
      resources:
        requests:
          ephemeral-storage: 70Gi
        limits:
          ephemeral-storage: 100Gi
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "alignment-bwa starting..."
          mkdir -p ${OUTDIR}
          echo "indexing reference genome..."
          cd ${REF_GENOME_PATH}
          bwa index ${REF_GENOME_FILENAME}
          echo "indexing done..."
          ls -la
          echo "running bwa mem..."
          echo "bwa mem - tumor samples"
          bwa mem ${REF_GENOME_FILENAME} ${TTUMOR_FASTQ1} ${TTUMOR_FASTQ2} > ${OUTDIR}/tumor.sam
          echo "bwa mem - normal samples"
          bwa mem ${REF_GENOME_FILENAME} ${TNORMAL_FASTQ1} ${TNORMAL_FASTQ2} > ${OUTDIR}/normal.sam
          echo "listing files alignment results..."
          ls -la ${OUTDIR}
          echo "done."
      env:
        - name: OUTDIR
          value: /mnt/data/alignment_results
        - name: REF_GENOME_FILENAME
          value: Homo_sapiens_assembly38.fasta
        - name: REF_GENOME_PATH
          value: /mnt/data/ref_genome
        - name: TTUMOR_FASTQ1
          value: /mnt/data/trimmed_data/trimmed_tumor_R1.fastq.gz
        - name: TTUMOR_FASTQ2
          value: /mnt/data/trimmed_data/trimmed_tumor_R2.fastq.gz
        - name: TNORMAL_FASTQ1
          value: /mnt/data/trimmed_data/trimmed_normal_R1.fastq.gz
        - name: TNORMAL_FASTQ2
          value: /mnt/data/trimmed_data/trimmed_normal_R2.fastq.gz
    inputs:
      artifacts:
        - name: ref-genome-data-out
          path: /mnt/data/ref_genome
        - name: trimming-out
          path: /mnt/data/trimmed_data
    outputs:
      artifacts:
        - name: alignment-bwa-out
          path: /mnt/data/alignment_results
    volumeMounts:
      - name: workdir
        mountPath: /mnt/data

  - name: alignment-samtools
    container:
      image: quay.io/biocontainers/samtools:0.1.19--2
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "alignment samtools starting..."
          samtools view -Sb ${DIRNAME}/tumor.sam | samtools sort -o ${DIRNAME}/tumor_sorted.bam -
          samtools view -Sb ${DIRNAME}/normal.sam | samtools sort -o ${DIRNAME}/normal_sorted.bam -
          echo "done."
      env:
        - name: DIRNAME
          value: /mnt/data/alignment_results
    inputs:
      artifacts:
        - name: alignment-bwa-out
          path: /mnt/data/alignment_results
    outputs:
      artifacts:
        - name: alignment-samtools-out
          path: /mnt/data/alignment_results
    volumeMounts:
      - name: workdir
        mountPath: /mnt/data

  - name: mark-duplicates
    container:
      image: quay.io/biocontainers/gatk4:4.5.0.0--py36hdfd78af_0
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "mark-duplicates starting..."
          mkdir -p ${OUTDIR}
          echo "marking duplicates..."
          gatk MarkDuplicates -I ${INDIR}/tumor_sorted.bam -O ${OUTDIR}/tumor_dedup.bam -M ${OUTDIR}/tumor_metrics.txt
          gatk MarkDuplicates -I ${INDIR}/normal_sorted.bam -O ${OUTDIR}/normal_dedup.bam -M ${OUTDIR}/normal_metrics.txt
          ls -la ${OUTDIR}
          echo "done."
      env:
        - name: INDIR
          value: /mnt/data/alignment_results
        - name: OUTDIR
          value: /mnt/data/mark_duplicates
    inputs:
      artifacts:
        - name: alignment-samtools-out
          path: /mnt/data/alignment_results
    outputs:
      artifacts:
        - name: mark-duplicates-out
          path: /mnt/data/mark_duplicates          
    volumeMounts:
      - name: workdir
        mountPath: /mnt/data

  - name: base-quality-score
    container:
      image: quay.io/biocontainers/gatk4:4.5.0.0--py36hdfd78af_0
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "base-quality-score starting..."
          mkdir -p ${OUTDIR}
          gatk BaseRecalibrator -I ${TUMOR_DEDUP} -R ${REF_GENOME} --known-sites ${KNOWN_SITES_VCF} -O ${OUTDIR}/tumor_recal_data.table
          gatk ApplyBQSR -R ${REF_GENOME} -I ${TUMOR_DEDUP} --bqsr-recal-file ${OUTDIR}/tumor_recal_data.table -O ${OUTDIR}/tumor_recal.bam
          gatk BaseRecalibrator -I ${NORMAL_DEDUP} -R ${REF_GENOME} --known-sites ${KNOWN_SITES_VCF} -O ${OUTDIR}/normal_recal_data.table
          gatk ApplyBQSR -R ${REF_GENOME} -I ${NORMAL_DEDUP} --bqsr-recal-file ${OUTDIR}/normal_recal_data.table -O ${OUTDIR}/normal_recal.bam
          ls -la ${OUTDIR}
          echo "done..."
      env:
        - name: OUTDIR
          value: /mnt/data/final_results
        - name: REF_GENOME
          value: /mnt/data/ref_genome/Homo_sapiens_assembly38.fasta
        - name: TUMOR_DEDUP
          value: /mnt/data/mark_duplicates/tumor_dedup.bam
        - name: NORMAL_DEDUP
          value: /mnt/data/mark_duplicates/normal_dedup.bam
        - name: KNOWN_SITES_VCF
          value: dbsnp_146.hg38.vcf.gz
    volumeMounts:
      - name: workdir
        mountPath: /mnt/data
    inputs:
      artifacts:
        - name: ref-genome-data-out
          path: /mnt/data/ref_genome
        - name: mark-duplicates-out
          path: /mnt/data/mark_duplicates 
    outputs:
      artifacts:
        - name: final-results
          path: /data/final_results
